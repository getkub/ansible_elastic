# https://github.com/elastic/integrations/blob/main/packages/symantec_edr_cloud/data_stream/incident/agent/stream/cel.yml.hbs
filebeat.inputs:
- type: cel
  interval: 10m
  resource:
    url: https://api.sunrise-sunset.org/json?lat=36.7201600&lng=-4.4203400
  state:
    initial_interval: 15m
    want_more: false
    limit: 1
    next: 0
  program: |
    (
      state.want_more
      ?
        state
      :
        state.with({
          "limit": state.limit,
          "start_date": (
            has(state.cursor) && has(state.cursor.last_timestamp) && state.cursor.last_timestamp != null
            ?
              state.cursor.last_timestamp
            :
              string(now - duration(state.initial_interval))
          ),
          "end_date": now,
          "et": now.format("2006-01-02T15:04:05") + "Z",
          "next": state.next
        })
    ).as(state,
      post_request(
        state.url + "/v1/incidents",
        "application/json",
        {
          "limit": state.limit,
          "start_date": state.start_date,
          "end_date": state.end_date,
          "next": state.next
        }.encode_json()
      ).do_request().as(resp, bytes(resp.Body).decode_json().as(body, {
        "events": body.incidents.map(e, {
          "message": e.encode_json(),
        }),
        "next": (
          has(body.next) && (body.next != body.total)
          ?
            body.next
          :
            0
        ),
        "want_more": has(body.next) && (body.next != body.total),
        "limit": state.limit,
        "start_date": string(state.start_date),
        "end_date": string(state.end_date),
        "cursor": {
          "last_timestamp": (
            (has(body.next) ? (body.next == body.total) : true)
            ?
              state.end_date
            :
              has(state.cursor) && has(state.cursor.last_timestamp)
              ?
                state.cursor.last_timestamp
              :
                null
          )
        }
      }))
      )

logging.level: debug
logging.metrics.enabled: false
logging.to_files: false

output.console:
  pretty: true
